<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>My TaskHub</title>

  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <meta name="theme-color" content="#4f46e5">

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
    body { font-family: 'Inter', sans-serif; }

    .priority-1 { border-left: 6px solid #ef4444; }
    .priority-2 { border-left: 6px solid #f59e0b; }
    .priority-3 { border-left: 6px solid #10b981; }

    .glass { background: rgba(255,255,255,.96); backdrop-filter: blur(12px); border: 1px solid rgba(15,23,42,.08); }
    .task-card { transition: transform .15s ease; }
    .task-card:active { transform: scale(.99); }

    #toast { transform: translateY(14px); opacity: 0; pointer-events: none; }
    #toast.show { transform: translateY(0); opacity: 1; pointer-events: auto; }

    input, select, textarea { color:#0f172a !important; -webkit-text-fill-color:#0f172a !important; }

    input[type="date"], input[type="time"]{
      background:#f1f5f9 !important;
      border:1px solid rgba(15,23,42,.10) !important;
      border-radius:14px !important;
      padding:10px 12px !important;
      width:100% !important;
      font-weight:800 !important;
      font-size:14px !important;
      box-shadow:0 1px 0 rgba(15,23,42,.04) inset;
    }

    textarea{
      background:#f1f5f9 !important;
      border:1px solid rgba(15,23,42,.10) !important;
      border-radius:14px !important;
      padding:10px 12px !important;
      width:100% !important;
      font-weight:700 !important;
      font-size:14px !important;
      box-shadow:0 1px 0 rgba(15,23,42,.04) inset;
      resize: none;
    }

    input[disabled]{ opacity:.55; }
    #alarmModal.hidden, #editModal.hidden { display:none; }
  </style>
</head>

<body class="bg-[#f8fafc] min-h-screen pb-24">

  <header class="sticky top-0 z-20 bg-[#f8fafc]/80 backdrop-blur-md px-6 py-6 flex justify-between items-center">
    <div>
      <h1 class="text-2xl font-extrabold text-slate-900 tracking-tight">
        My <span class="text-indigo-600">TaskHub</span>
      </h1>
      <p id="stats" class="text-xs font-semibold text-slate-400 uppercase tracking-widest mt-1">Lade...</p>
    </div>
    <div class="h-10 w-10 bg-indigo-100 rounded-full flex items-center justify-center">
      <span class="text-indigo-600 text-sm font-bold">MT</span>
    </div>
  </header>

  <!-- Toast -->
  <div class="fixed left-0 right-0 bottom-6 z-50 px-5">
    <div id="toast" class="max-w-md mx-auto glass rounded-2xl px-4 py-3 shadow-lg transition-all duration-200">
      <p id="toastText" class="text-sm font-extrabold text-slate-900"></p>
      <p id="toastSub" class="text-xs font-semibold text-slate-500 mt-1"></p>
    </div>
  </div>

  <!-- In-App Alarm Modal -->
  <div id="alarmModal" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="absolute left-0 right-0 top-24 px-5">
      <div class="max-w-md mx-auto glass rounded-3xl p-5 shadow-xl">
        <p class="text-sm font-black uppercase text-slate-400">Erinnerung</p>
        <p id="alarmTitle" class="text-xl font-extrabold text-slate-900 mt-1"></p>
        <p id="alarmSub" class="text-sm font-bold text-slate-600 mt-2"></p>

        <div class="grid grid-cols-2 gap-3 mt-5">
          <button id="alarmDoneBtn" class="bg-indigo-600 text-white rounded-2xl py-3 font-extrabold active:opacity-90">Erledigt</button>
          <button id="alarmCloseBtn" class="bg-slate-900 text-white rounded-2xl py-3 font-extrabold active:opacity-90">Schlie√üen</button>
        </div>

        <p class="text-[11px] font-semibold text-slate-400 mt-3">
          Hinweis: In-App Erinnerungen funktionieren zuverl√§ssig nur, solange TaskHub offen ist.
        </p>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="editModal" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="absolute left-0 right-0 top-16 px-5">
      <div class="max-w-md mx-auto glass rounded-3xl p-5 shadow-xl">
        <div class="flex items-start justify-between gap-4">
          <div>
            <p class="text-sm font-black uppercase text-slate-400">Aufgabe bearbeiten</p>
            <p class="text-xs font-semibold text-slate-500 mt-1">√Ñnderungen speichern oder abbrechen.</p>
          </div>
          <button id="editCloseX" class="text-slate-500 font-black text-xl leading-none">√ó</button>
        </div>

        <div class="mt-4 space-y-3">
          <div>
            <label class="text-[11px] font-black uppercase text-slate-400">Titel</label>
            <input id="editTitle" type="text"
              autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"
              class="mt-1 w-full bg-slate-100 rounded-xl px-3 py-2 text-sm font-bold text-slate-700 outline-none border border-slate-200" />
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-[11px] font-black uppercase text-slate-400">Projekt</label>
              <select id="editProject" class="mt-1 w-full bg-slate-100 rounded-xl px-3 py-2 text-sm font-bold text-slate-700 outline-none border border-slate-200">
                <option value="Sonstiges">Sonstiges</option>
                <option value="Academy">Academy</option>
                <option value="HSE">HSE</option>
                <option value="Recruiting">Recruiting</option>
              </select>
            </div>
            <div>
              <label class="text-[11px] font-black uppercase text-slate-400">Priorit√§t</label>
              <select id="editPrio" class="mt-1 w-full bg-slate-100 rounded-xl px-3 py-2 text-sm font-bold text-slate-700 outline-none border border-slate-200">
                <option value="1">üî• Hoch</option>
                <option value="2">‚ö° Mittel</option>
                <option value="3">üå± Niedrig</option>
              </select>
            </div>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div>
              <label class="text-[11px] font-black uppercase text-slate-400">Datum</label>
              <input id="editDate" type="date" class="mt-1" />
            </div>
            <div>
              <label class="text-[11px] font-black uppercase text-slate-400">Uhrzeit</label>
              <input id="editTime" type="time" class="mt-1" />
            </div>
          </div>

          <div class="flex items-center gap-2 pt-1">
            <input id="editClearWhen" type="checkbox" class="h-4 w-4" />
            <label for="editClearWhen" class="text-xs font-bold text-slate-600">Termin entfernen</label>
          </div>
          
          <div>
  <label class="text-[11px] font-black uppercase text-slate-400">Notizen</label>
  <textarea id="editNotes" rows="3"
    autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"
    class="mt-1 w-full bg-slate-100 rounded-xl px-3 py-2 text-sm font-bold text-slate-700 outline-none border border-slate-200"
    placeholder="z.B. Grund / Status / n√§chster Schritt‚Ä¶"></textarea>
</div>

          <div>
            <label class="text-[11px] font-black uppercase text-slate-400">Notizen</label>
            <textarea id="editNotes" rows="3"
              autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"
              placeholder="z.B. Grund / Status / n√§chster Schritt‚Ä¶"></textarea>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3 mt-5">
          <button id="editSaveBtn" class="bg-indigo-600 text-white rounded-2xl py-3 font-extrabold active:opacity-90">Speichern</button>
          <button id="editCancelBtn" class="bg-slate-900 text-white rounded-2xl py-3 font-extrabold active:opacity-90">Abbrechen</button>
        </div>
      </div>
    </div>
  </div>

  <main class="max-w-md mx-auto px-5">

    <!-- ADD TASK -->
    <section class="glass rounded-3xl p-5 shadow-sm mb-6">
      <input id="taskTitle" type="text" placeholder="Neue Aufgabe tippen..."
        autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"
        class="w-full text-lg font-semibold bg-transparent border-none focus:ring-0 outline-none mb-4 text-slate-800">

      <div class="grid grid-cols-2 gap-3 mb-4">
        <select id="taskProject" class="bg-slate-100 rounded-xl px-3 py-2 text-sm font-bold text-slate-700 outline-none border border-slate-200">
          <option value="Sonstiges" selected>Sonstiges</option>
          <option value="Academy">Academy</option>
          <option value="HSE">HSE</option>
          <option value="Recruiting">Recruiting</option>
        </select>

        <select id="taskPrio" class="bg-slate-100 rounded-xl px-3 py-2 text-sm font-bold text-slate-700 outline-none border border-slate-200">
          <option value="1">üî• Hoch</option>
          <option value="2" selected>‚ö° Mittel</option>
          <option value="3">üå± Niedrig</option>
        </select>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
        <div>
          <label class="text-[11px] font-black uppercase text-slate-400">Datum (optional)</label>
          <input id="taskDate" type="date" class="mt-1" />
        </div>
        <div>
          <label class="text-[11px] font-black uppercase text-slate-400">Uhrzeit (optional)</label>
          <input id="taskTime" type="time" class="mt-1" />
        </div>
      </div>

      <button id="addTaskBtn"
        class="w-full bg-slate-900 text-white font-bold py-3.5 rounded-2xl active:bg-slate-800 transition-colors shadow-lg">
        Hinzuf√ºgen
      </button>
    </section>

    <!-- FILTERS -->
    <section class="glass rounded-3xl p-4 shadow-sm mb-6">
      <div class="flex items-center gap-2 mb-3">
        <button class="filterBtn flex-1 rounded-2xl py-2 text-xs font-extrabold uppercase" data-filter="active">Offen</button>
        <button class="filterBtn flex-1 rounded-2xl py-2 text-xs font-extrabold uppercase" data-filter="all">Alle</button>
        <button class="filterBtn flex-1 rounded-2xl py-2 text-xs font-extrabold uppercase" data-filter="completed">Erledigt</button>
      </div>

      <div class="grid grid-cols-2 gap-3">
        <select id="projectFilter" class="bg-slate-100 rounded-xl px-3 py-2 text-sm font-bold text-slate-700 outline-none border border-slate-200">
          <option value="all">Alle Projekte</option>
          <option value="Sonstiges">Sonstiges</option>
          <option value="Academy">Academy</option>
          <option value="HSE">HSE</option>
          <option value="Recruiting">Recruiting</option>
        </select>

        <input id="searchInput" type="search" placeholder="Suchen..."
          class="bg-slate-100 rounded-xl px-3 py-2 text-sm font-bold text-slate-700 outline-none border border-slate-200">
      </div>

      <div class="grid grid-cols-2 gap-3 mt-3">
        <select id="sortMode" class="bg-slate-100 rounded-xl px-3 py-2 text-sm font-bold text-slate-700 outline-none border border-slate-200">
          <option value="smart" selected>Sort: Smart</option>
          <option value="when">Sort: Datum/Uhrzeit</option>
          <option value="prio">Sort: Priorit√§t</option>
          <option value="created">Sort: Neu ‚Üí Alt</option>
        </select>

        <button id="reminderBtn"
          class="bg-slate-900 text-white rounded-xl px-3 py-2 text-sm font-extrabold active:bg-slate-800">
          Erinnerungen aktivieren
        </button>
      </div>

      <p id="reminderHint" class="text-[11px] font-semibold text-slate-400 mt-3 leading-snug">
        Erinnerungen sind aus. Tipp: Aktivieren ‚Üí TaskHub offen lassen ‚Üí Popup erscheint zum Termin.
      </p>
    </section>

    <div id="taskList" class="space-y-4 mb-10"></div>
  </main>

  <script>
    // ===== Storage (mit Migration, damit Aufgaben nicht "weg" sind) =====
    const KEY = "taskhub_data_v1";
    const OLD_KEYS = ["taskhub_final_with_prio_badge_v1", "myTaskHubData", "taskhub_data_v1"];

    (function migrate(){
      try{
        const cur = localStorage.getItem(KEY);
        if(cur && cur !== "[]") return;
        for(const k of OLD_KEYS){
          const old = localStorage.getItem(k);
          if(old && old !== "[]"){
            localStorage.setItem(KEY, old);
            return;
          }
        }
      }catch(e){}
    })();

    const $ = (id) => document.getElementById(id);

    function load(){ try { return JSON.parse(localStorage.getItem(KEY)) || []; } catch { return []; } }
    function save(list){ localStorage.setItem(KEY, JSON.stringify(list)); }

    let tasks = load().map(t => ({ ...t, notes: (t.notes ?? "") }));

    // ===== Reminders =====
    const REM_KEY = "taskhub_reminders_enabled_v1";
    let remindersEnabled = localStorage.getItem(REM_KEY) === "1";
    let reminderTimeout = null;
    let currentAlarmTaskId = null;

    // ===== Edit state =====
    let editingTaskId = null;

    // ===== Toast =====
    let toastTimer=null;
    function toast(title, sub=""){
      $("toastText").textContent = title;
      $("toastSub").textContent = sub;
      $("toast").classList.add("show");
      if(toastTimer) clearTimeout(toastTimer);
      toastTimer = setTimeout(()=> $("toast").classList.remove("show"), 2600);
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    function formatWhenMs(ms){
      if(!ms) return "Kein Termin";
      const d = new Date(ms);
      const pad = (n)=>String(n).padStart(2,"0");
      return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    function buildWhen(dateStr, timeStr){
      if(!dateStr) return null;
      const t = (timeStr && timeStr.includes(":")) ? timeStr : "09:00";
      const [y,m,d] = dateStr.split("-").map(Number);
      const [hh,mm] = t.split(":").map(Number);
      const dt = new Date(y, (m-1), d, hh, mm, 0, 0);
      return isNaN(dt.getTime()) ? null : dt.getTime();
    }

    function splitWhen(ms){
      if(!ms) return {date:"", time:""};
      const d = new Date(ms);
      const pad = (n)=>String(n).padStart(2,"0");
      return {
        date: `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`,
        time: `${pad(d.getHours())}:${pad(d.getMinutes())}`
      };
    }

    function prioLabel(prio){
      if(prio === 1) return "üî• Hoch";
      if(prio === 2) return "‚ö° Mittel";
      return "üå± Niedrig";
    }

    function prioBadgeClass(prio){
      if(prio === 1) return "bg-red-100 text-red-700";
      if(prio === 2) return "bg-amber-100 text-amber-700";
      return "bg-emerald-100 text-emerald-700";
    }

    // ===== Edit Modal =====
    function openEditModal(task){
      editingTaskId = task.id;

      $("editTitle").value = task.title || "";
      $("editProject").value = task.project || "Sonstiges";
      $("editPrio").value = String(task.prio || 2);
      $("editNotes").value = task.notes || "";

      const parts = splitWhen(task.when);
      $("editDate").value = parts.date;
      $("editTime").value = parts.time;

      const noWhen = !task.when;
      $("editClearWhen").checked = noWhen;
      $("editDate").disabled = noWhen;
      $("editTime").disabled = noWhen;

      $("editModal").classList.remove("hidden");
      $("editTitle").focus();
    }

    function closeEditModal(){
      $("editModal").classList.add("hidden");
      editingTaskId = null;
    }

    $("editCancelBtn").onclick = closeEditModal;
    $("editCloseX").onclick = closeEditModal;

    $("editClearWhen").addEventListener("change", ()=>{
      const on = $("editClearWhen").checked;
      if(on){
        $("editDate").value = "";
        $("editTime").value = "";
        $("editDate").disabled = true;
        $("editTime").disabled = true;
      } else {
        $("editDate").disabled = false;
        $("editTime").disabled = false;
        $("editDate").focus();
      }
    });

    $("editSaveBtn").onclick = ()=>{
      if(!editingTaskId) return;

      const title = ($("editTitle").value||"").trim();
      if(!title){
        toast("Titel fehlt", "Bitte Titel eingeben.");
        $("editTitle").focus();
        return;
      }

      const clearWhen = $("editClearWhen").checked;
      const whenMs = clearWhen ? null : buildWhen($("editDate").value, $("editTime").value);

      tasks = tasks.map(t=>{
        if(t.id !== editingTaskId) return t;
        return {
          ...t,
          title,
          project: $("editProject").value,
          prio: parseInt($("editPrio").value,10) || 2,
          notes: ($("editNotes").value || "").trim(),
          when: whenMs
        };
      });

      save(tasks);
      renderAll();
      scheduleNextReminder();
      closeEditModal();

      // Fokus weg, damit iOS nichts "reinschiebt"
      setTimeout(() => document.activeElement && document.activeElement.blur(), 0);

      toast(clearWhen ? "Termin entfernt ‚úÖ" : "Gespeichert ‚úÖ");
    };

    // ===== Filters / Sorting =====
    function activeFilter(){ return document.querySelector(".filterBtn.bg-slate-900")?.dataset.filter || "active"; }

    function getVisibleTasks(){
      const filter = activeFilter();
      const proj = $("projectFilter").value;
      const q = ($("searchInput").value||"").trim().toLowerCase();
      const sortMode = $("sortMode").value;

      let list = tasks.slice();
      if(filter==="active") list = list.filter(t=>!t.done);
      if(filter==="completed") list = list.filter(t=>t.done);
      if(proj!=="all") list = list.filter(t=>t.project===proj);
      if(q) list = list.filter(t => (t.title||"").toLowerCase().includes(q) || (t.notes||"").toLowerCase().includes(q));

      list.sort((a,b)=>{
        if(filter==="all" && a.done!==b.done) return a.done?1:-1;
        if(sortMode==="created") return (b.createdAt||0)-(a.createdAt||0);
        if(sortMode==="prio") return (a.prio||2)-(b.prio||2);
        const aw = a.when ? a.when : 9e15;
        const bw = b.when ? b.when : 9e15;
        if(aw!==bw) return aw-bw;
        return (b.createdAt||0)-(a.createdAt||0);
      });

      return list;
    }

    function renderStats(){
      const open = tasks.filter(t=>!t.done).length;
      $("stats").textContent = `${open} offen ¬∑ ${tasks.length-open} erledigt`;
    }

    function renderList(){
      const wrap = $("taskList");
      wrap.innerHTML = "";
      const visible = getVisibleTasks();

      if(visible.length===0){
        wrap.innerHTML = `
          <div class="glass rounded-3xl p-6 text-center">
            <p class="text-sm font-extrabold text-slate-900">Keine Aufgaben</p>
            <p class="text-xs font-semibold text-slate-500 mt-2">F√ºge oben eine neue Aufgabe hinzu oder √§ndere deine Filter.</p>
          </div>
        `;
        return;
      }

      visible.forEach(t=>{
        const badge = prioLabel(t.prio);
        const badgeCls = prioBadgeClass(t.prio);

        const card = document.createElement("div");
        card.className = `task-card glass priority-${t.prio} p-4 rounded-2xl shadow-sm flex items-center gap-4 ${t.done ? "opacity-40" : ""}`;

        card.innerHTML = `
          <button class="toggle h-7 w-7 rounded-full border-2 border-indigo-500 flex-shrink-0 flex items-center justify-center" data-id="${t.id}">
            ${t.done ? '<div class="h-4 w-4 bg-indigo-500 rounded-full"></div>' : ''}
          </button>

          <div class="flex-grow min-w-0">
            <div class="flex items-start justify-between gap-2">
              <h3 class="font-extrabold text-slate-800 ${t.done ? "line-through" : ""} truncate">${escapeHtml(t.title)}</h3>

              <div class="flex items-center gap-2 flex-shrink-0">
                <span class="text-[10px] font-black uppercase text-slate-400">${escapeHtml(t.project||"")}</span>
                <span class="px-2 py-1 rounded-full text-[10px] font-black ${badgeCls}">${badge}</span>
              </div>
            </div>

            <div class="flex flex-wrap gap-x-3 gap-y-1 mt-1 items-center">
              <span class="text-[10px] font-black uppercase text-slate-400">üìÖ ${escapeHtml(formatWhenMs(t.when))}</span>
              ${t.notes ? `<span class="text-[10px] font-semibold text-slate-500">üóíÔ∏è ${escapeHtml(t.notes)}</span>` : ""}
            </div>

            <div class="flex flex-wrap gap-3 mt-2 items-center">
              <button class="edit text-[10px] font-black uppercase text-indigo-600 active:scale-95" data-id="${t.id}">Bearbeiten</button>
              <button class="del text-[10px] font-black uppercase text-red-400 active:scale-95" data-id="${t.id}">L√∂schen</button>
            </div>
          </div>
        `;
        wrap.appendChild(card);
      });

      document.querySelectorAll(".toggle").forEach(btn=>{
        btn.onclick = ()=>{
          const id = btn.dataset.id;
          tasks = tasks.map(t=> t.id===id ? ({...t, done: !t.done}) : t);
          save(tasks);
          renderAll();
          scheduleNextReminder();
        };
      });

      document.querySelectorAll(".del").forEach(btn=>{
        btn.onclick = ()=>{
          const id = btn.dataset.id;
          tasks = tasks.filter(t=>t.id!==id);
          save(tasks);
          renderAll();
          scheduleNextReminder();
        };
      });

      document.querySelectorAll(".edit").forEach(btn=>{
        btn.onclick = ()=>{
          const id = btn.dataset.id;
          const task = tasks.find(t=>t.id===id);
          if(task) openEditModal(task);
        };
      });
    }

    function updateReminderUI(){
      $("reminderBtn").textContent = remindersEnabled ? "Erinnerungen: aktiv ‚úÖ" : "Erinnerungen aktivieren";
      $("reminderHint").textContent = remindersEnabled
        ? "Erinnerungen sind aktiv. Hinweis: zuverl√§ssig nur, solange TaskHub offen ist."
        : "Erinnerungen sind aus. Tipp: Aktivieren ‚Üí TaskHub offen lassen ‚Üí Popup erscheint zum Termin.";
    }

    function renderAll(){
      renderStats();
      renderList();
      updateReminderUI();
    }

    // ===== Add Task =====
    function addTask(){
      const title = ($("taskTitle").value||"").trim();
      if(!title){
        toast("Titel fehlt", "Bitte oben einen Titel eingeben.");
        $("taskTitle").focus();
        return;
      }

      const whenMs = buildWhen($("taskDate").value, $("taskTime").value);

      tasks.push({
        id: String(Date.now()),
        title,
        project: $("taskProject").value,
        prio: parseInt($("taskPrio").value,10) || 2,
        when: whenMs,
        notes: "",
        done: false,
        createdAt: Date.now()
      });

      save(tasks);

      $("taskTitle").value="";
      $("taskDate").value="";
      $("taskTime").value="";

      renderAll();
      scheduleNextReminder();
      toast("Aufgabe hinzugef√ºgt");
    }

    // ===== Reminders scheduling =====
    function nextReminder(){
      const now = Date.now();
      return tasks
        .filter(t=>!t.done && t.when && t.when >= now)
        .sort((a,b)=> a.when - b.when)[0] || null;
    }

    function scheduleNextReminder(){
      if(reminderTimeout){ clearTimeout(reminderTimeout); reminderTimeout=null; }
      if(!remindersEnabled) return;

      const nxt = nextReminder();
      if(!nxt) return;

      const delay = Math.max(0, nxt.when - Date.now());
      reminderTimeout = setTimeout(()=> {
        currentAlarmTaskId = nxt.id;
        $("alarmTitle").textContent = nxt.title;
        $("alarmSub").textContent = `${nxt.project} ¬∑ ${formatWhenMs(nxt.when)}`;
        $("alarmModal").classList.remove("hidden");
      }, delay);
    }

    $("alarmCloseBtn").onclick = ()=>{
      $("alarmModal").classList.add("hidden");
      scheduleNextReminder();
    };

    $("alarmDoneBtn").onclick = ()=>{
      if(currentAlarmTaskId){
        tasks = tasks.map(t=> t.id===currentAlarmTaskId ? ({...t, done:true}) : t);
        save(tasks);
        renderAll();
      }
      $("alarmModal").classList.add("hidden");
      scheduleNextReminder();
    };

    function toggleReminders(){
      remindersEnabled = !remindersEnabled;
      localStorage.setItem(REM_KEY, remindersEnabled ? "1" : "0");
      updateReminderUI();

      if(remindersEnabled){
        toast("Erinnerungen aktiviert ‚úÖ", "TaskHub bitte offen lassen.");
        scheduleNextReminder();
      } else {
        if(reminderTimeout) clearTimeout(reminderTimeout);
        reminderTimeout = null;
        toast("Erinnerungen aus", "");
      }
    }

    // ===== Startup =====
    window.addEventListener("load", ()=>{
      // Filter buttons init
      document.querySelectorAll(".filterBtn").forEach(btn=>{
        btn.className = "filterBtn flex-1 rounded-2xl py-2 text-xs font-extrabold uppercase bg-slate-100 text-slate-600";
      });
      const first = document.querySelector('.filterBtn[data-filter="active"]');
      if(first) first.className = "filterBtn flex-1 rounded-2xl py-2 text-xs font-extrabold uppercase bg-slate-900 text-white";

      document.querySelectorAll(".filterBtn").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          document.querySelectorAll(".filterBtn").forEach(b=> b.className =
            "filterBtn flex-1 rounded-2xl py-2 text-xs font-extrabold uppercase bg-slate-100 text-slate-600"
          );
          btn.className = "filterBtn flex-1 rounded-2xl py-2 text-xs font-extrabold uppercase bg-slate-900 text-white";
          renderAll();
        });
      });

      $("projectFilter").addEventListener("change", renderAll);
      $("searchInput").addEventListener("input", renderAll);
      $("sortMode").addEventListener("change", renderAll);

      $("addTaskBtn").addEventListener("click", addTask);
      $("taskTitle").addEventListener("keydown", (e)=>{ if(e.key==="Enter") addTask(); });

      $("reminderBtn").addEventListener("click", toggleReminders);

      renderAll();
      scheduleNextReminder();
      toast("Bereit ‚úÖ", remindersEnabled ? "Erinnerungen aktiv (TaskHub offen lassen)." : "Erinnerungen sind aus.");
    });
  </script>
</body>
</html>
