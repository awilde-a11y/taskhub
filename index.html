<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>My TaskHub</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
    body { font-family: 'Inter', sans-serif; }

    .priority-1 { border-left: 6px solid #ef4444; }
    .priority-2 { border-left: 6px solid #f59e0b; }
    .priority-3 { border-left: 6px solid #10b981; }

    .glass { background: rgba(255,255,255,.95); backdrop-filter: blur(12px); border: 1px solid rgba(0,0,0,.06); }
    .task-card { transition: transform .15s ease; }
    .task-card:active { transform: scale(.99); }

    #toast { transform: translateY(14px); opacity: 0; pointer-events: none; }
    #toast.show { transform: translateY(0); opacity: 1; pointer-events: auto; }
  </style>
</head>

<body class="bg-[#f8fafc] min-h-screen pb-24">

  <header class="sticky top-0 z-20 bg-[#f8fafc]/80 backdrop-blur-md px-6 py-6 flex justify-between items-center">
    <div>
      <h1 class="text-2xl font-extrabold text-slate-900 tracking-tight">
        My <span class="text-indigo-600">TaskHub</span>
      </h1>
      <p id="stats" class="text-xs font-semibold text-slate-400 uppercase tracking-widest mt-1">Lade...</p>
    </div>
    <div class="h-10 w-10 bg-indigo-100 rounded-full flex items-center justify-center">
      <span class="text-indigo-600 text-sm font-bold">MT</span>
    </div>
  </header>

  <!-- Toast -->
  <div class="fixed left-0 right-0 bottom-6 z-50 px-5">
    <div id="toast" class="max-w-md mx-auto glass rounded-2xl px-4 py-3 shadow-lg border border-slate-200 transition-all duration-200">
      <p id="toastText" class="text-sm font-extrabold text-slate-900"></p>
      <p id="toastSub" class="text-xs font-semibold text-slate-500 mt-1"></p>
    </div>
  </div>

  <main class="max-w-md mx-auto px-5">

    <!-- ADD TASK -->
    <section class="glass rounded-3xl p-5 shadow-sm border border-slate-200 mb-6">
      <input id="taskTitle" type="text" placeholder="Neue Aufgabe tippen..."
        class="w-full text-lg font-semibold bg-transparent border-none focus:ring-0 outline-none mb-4 text-slate-800">

      <div class="grid grid-cols-2 gap-3 mb-3">
        <select id="taskProject" class="bg-slate-100 rounded-xl px-3 py-2 text-sm font-bold text-slate-600 appearance-none outline-none">
          <option value="Academy">Academy</option>
          <option value="HSE">HSE</option>
          <option value="Recruiting">Recruiting</option>
          <option value="Inbox" selected>Inbox</option>
        </select>

        <select id="taskPrio" class="bg-slate-100 rounded-xl px-3 py-2 text-sm font-bold text-slate-600 appearance-none outline-none">
          <option value="1">üî• Hoch</option>
          <option value="2" selected>‚ö° Mittel</option>
          <option value="3">üå± Niedrig</option>
        </select>
      </div>

      <!-- HIER ist die √Ñnderung: Datum + Uhrzeit + Notiz -->
      <div class="grid grid-cols-2 gap-3 mb-3">
        <input id="taskDeadline" type="date"
          class="bg-slate-100 rounded-xl px-3 py-2 text-sm font-bold text-slate-600 outline-none">
        <input id="taskTime" type="time"
          class="bg-slate-100 rounded-xl px-3 py-2 text-sm font-bold text-slate-600 outline-none">
      </div>

      <input id="taskNotes" type="text" placeholder="Notiz (optional)"
        class="w-full bg-slate-100 rounded-xl px-3 py-2 text-sm font-bold text-slate-600 outline-none mb-4">

      <button id="addTaskBtn"
        class="w-full bg-slate-900 text-white font-bold py-3.5 rounded-2xl active:bg-slate-800 transition-colors shadow-lg">
        Hinzuf√ºgen
      </button>

      <p class="text-[11px] font-semibold text-slate-400 mt-3 leading-snug">
        Tipp: Setze Datum + Uhrzeit, dann kann eine Erinnerung genau zu diesem Zeitpunkt ausgel√∂st werden.
      </p>
    </section>

    <!-- FILTERS -->
    <section class="glass rounded-3xl p-4 shadow-sm border border-slate-200 mb-6">
      <div class="flex items-center gap-2 mb-3">
        <button class="filterBtn flex-1 rounded-2xl py-2 text-xs font-extrabold uppercase" data-filter="active">Offen</button>
        <button class="filterBtn flex-1 rounded-2xl py-2 text-xs font-extrabold uppercase" data-filter="all">Alle</button>
        <button class="filterBtn flex-1 rounded-2xl py-2 text-xs font-extrabold uppercase" data-filter="completed">Erledigt</button>
      </div>

      <div class="grid grid-cols-2 gap-3">
        <select id="projectFilter" class="bg-slate-100 rounded-xl px-3 py-2 text-sm font-bold text-slate-600 appearance-none outline-none">
          <option value="all">Alle Projekte</option>
          <option value="Academy">Academy</option>
          <option value="HSE">HSE</option>
          <option value="Recruiting">Recruiting</option>
          <option value="Inbox">Inbox</option>
        </select>

        <input id="searchInput" type="search" placeholder="Suchen..."
          class="bg-slate-100 rounded-xl px-3 py-2 text-sm font-bold text-slate-600 outline-none">
      </div>

      <div class="grid grid-cols-2 gap-3 mt-3">
        <select id="sortMode" class="bg-slate-100 rounded-xl px-3 py-2 text-sm font-bold text-slate-600 appearance-none outline-none">
          <option value="smart" selected>Sort: Smart</option>
          <option value="deadline">Sort: Datum</option>
          <option value="prio">Sort: Priorit√§t</option>
          <option value="created">Sort: Neu ‚Üí Alt</option>
        </select>

        <button id="requestNotifyBtn"
          class="bg-slate-900 text-white rounded-xl px-3 py-2 text-sm font-extrabold active:bg-slate-800">
          Erinnerungen aktivieren
        </button>
      </div>

      <p class="text-[11px] font-semibold text-slate-400 mt-3 leading-snug">
        Ohne Server funktionieren Erinnerungen zuverl√§ssig, solange die Seite/App offen ist. (Hintergrund-Push im komplett geschlossenen Zustand ist im Web eingeschr√§nkt.)
      </p>
    </section>

    <div id="taskList" class="space-y-4 mb-10"></div>
  </main>

  <script>
    // ---------- Storage ----------
    const KEY = "taskhub_with_time_v1";

    function load() {
      try { return JSON.parse(localStorage.getItem(KEY)) || []; }
      catch { return []; }
    }
    function save(tasks) { localStorage.setItem(KEY, JSON.stringify(tasks)); }

    let tasks = load();

    const $ = (id) => document.getElementById(id);

    // ---------- Toast ----------
    let toastTimer = null;
    function toast(title, sub="") {
      $("toastText").textContent = title;
      $("toastSub").textContent = sub;
      $("toast").classList.add("show");
      if (toastTimer) clearTimeout(toastTimer);
      toastTimer = setTimeout(() => $("toast").classList.remove("show"), 2500);
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    function todayISO() { return new Date().toISOString().slice(0,10); }

    function renderStats() {
      const open = tasks.filter(t => !t.done).length;
      $("stats").textContent = `${open} offen ¬∑ ${tasks.length - open} erledigt`;
    }

    function getVisibleTasks() {
      const filter = document.querySelector(".filterBtn.bg-slate-900")?.dataset.filter || "active";
      const proj = $("projectFilter").value;
      const q = ($("searchInput").value || "").trim().toLowerCase();
      const sortMode = $("sortMode").value;

      let list = tasks.slice();

      if (filter === "active") list = list.filter(t => !t.done);
      if (filter === "completed") list = list.filter(t => t.done);

      if (proj !== "all") list = list.filter(t => t.project === proj);

      if (q) list = list.filter(t =>
        (t.title||"").toLowerCase().includes(q) || (t.notes||"").toLowerCase().includes(q)
      );

      const deadlineKey = (t) => t.date ? t.date.replace(/-/g,"") : "99999999";
      const timeKey = (t) => t.time ? t.time.replace(":","") : "9999";

      list.sort((a,b) => {
        // open first
        if (filter === "all" && a.done !== b.done) return a.done ? 1 : -1;

        if (sortMode === "created") return b.createdAt - a.createdAt;
        if (sortMode === "prio") return a.prio - b.prio;
        if (sortMode === "deadline") {
          const d = deadlineKey(a).localeCompare(deadlineKey(b));
          if (d !== 0) return d;
          return timeKey(a).localeCompare(timeKey(b)) || (a.prio - b.prio);
        }

        // smart
        const d = deadlineKey(a).localeCompare(deadlineKey(b));
        if (d !== 0) return d;
        const t = timeKey(a).localeCompare(timeKey(b));
        if (t !== 0) return t;
        const p = a.prio - b.prio;
        if (p !== 0) return p;
        return b.createdAt - a.createdAt;
      });

      return list;
    }

    function renderList() {
      const list = $("taskList");
      list.innerHTML = "";
      const visible = getVisibleTasks();

      if (visible.length === 0) {
        list.innerHTML = `
          <div class="glass rounded-3xl p-6 border border-slate-200 text-center">
            <p class="text-sm font-extrabold text-slate-900">Keine Aufgaben</p>
            <p class="text-xs font-semibold text-slate-500 mt-2">F√ºge oben eine neue Aufgabe hinzu oder √§ndere deine Filter.</p>
          </div>
        `;
        return;
      }

      visible.forEach(t => {
        const card = document.createElement("div");
        card.className = `task-card glass priority-${t.prio} p-4 rounded-2xl shadow-sm flex items-center gap-4 ${t.done ? "opacity-40" : ""}`;

        card.innerHTML = `
          <button class="toggle h-7 w-7 rounded-full border-2 border-indigo-500 flex-shrink-0 flex items-center justify-center" data-id="${t.id}">
            ${t.done ? '<div class="h-4 w-4 bg-indigo-500 rounded-full"></div>' : ''}
          </button>

          <div class="flex-grow min-w-0">
            <div class="flex items-start justify-between gap-2">
              <h3 class="font-extrabold text-slate-800 ${t.done ? "line-through" : ""} truncate">${escapeHtml(t.title)}</h3>
              <span class="text-[10px] font-black uppercase text-slate-400 flex-shrink-0">${escapeHtml(t.project)}</span>
            </div>

            <div class="flex flex-wrap gap-x-3 gap-y-1 mt-1 items-center">
              <span class="text-[10px] font-black uppercase text-slate-400">üìÖ ${t.date || "Kein Datum"}</span>
              ${t.time ? `<span class="text-[10px] font-black uppercase text-slate-400">‚è∞ ${t.time}</span>` : ""}
              ${t.notes ? `<span class="text-[10px] font-black uppercase text-slate-400">üóíÔ∏è ${escapeHtml(t.notes)}</span>` : ""}
            </div>

            <div class="flex gap-3 mt-2">
              <button class="del text-[10px] font-black uppercase text-red-400 active:scale-95" data-id="${t.id}">L√∂schen</button>
            </div>
          </div>
        `;

        list.appendChild(card);
      });

      document.querySelectorAll(".toggle").forEach(btn => {
        btn.onclick = () => {
          const id = btn.dataset.id;
          tasks = tasks.map(t => t.id === id ? ({...t, done: !t.done}) : t);
          save(tasks);
          renderAll();
          scheduleNextReminder();
        };
      });

      document.querySelectorAll(".del").forEach(btn => {
        btn.onclick = () => {
          const id = btn.dataset.id;
          tasks = tasks.filter(t => t.id !== id);
          save(tasks);
          renderAll();
          scheduleNextReminder();
        };
      });
    }

    function renderAll() {
      renderStats();
      renderList();
    }

    // ---------- Reminder engine ----------
    let remindersEnabled = false;
    let reminderTimeout = null;

    function taskReminderDate(t) {
      if (!t.date || !t.time) return null;
      const d = new Date(`${t.date}T${t.time}:00`);
      return isNaN(d.getTime()) ? null : d;
    }

    function nextReminderTask() {
      const now = Date.now();
      const candidates = tasks
        .filter(t => !t.done)
        .map(t => ({ t, d: taskReminderDate(t) }))
        .filter(x => x.d && x.d.getTime() >= now)
        .sort((a,b) => a.d.getTime() - b.d.getTime());

      return candidates.length ? candidates[0] : null;
    }

    function scheduleNextReminder() {
      if (reminderTimeout) {
        clearTimeout(reminderTimeout);
        reminderTimeout = null;
      }
      if (!remindersEnabled) return;

      const nxt = nextReminderTask();
      if (!nxt) {
        toast("Erinnerungen aktiv", "Keine Aufgabe mit Datum + Uhrzeit gefunden.");
        return;
      }

      const delay = Math.max(0, nxt.d.getTime() - Date.now());

      reminderTimeout = setTimeout(() => {
        fireReminder(nxt.t);
      }, delay);

      toast("Erinnerungen aktiv", `N√§chste: ${nxt.t.title} um ${nxt.t.time}`);
    }

    function fireReminder(task) {
      const title = "TaskHub ‚Äì Erinnerung";
      const body = `${task.title} (${task.project})`;

      let notified = false;
      if ("Notification" in window && Notification.permission === "granted") {
        try { new Notification(title, { body }); notified = true; } catch {}
      }

      if (!notified) toast("Erinnerung", body);
      else toast("Erinnerung gesendet", body);

      scheduleNextReminder();
    }

    async function toggleReminders() {
      if (!remindersEnabled) {
        remindersEnabled = true;

        if ("Notification" in window && Notification.permission === "default") {
          try { await Notification.requestPermission(); } catch {}
        }

        if ("Notification" in window && Notification.permission === "denied") {
          toast("Hinweis", "Notifications sind blockiert ‚Äì ich nutze In-App Hinweise.");
        } else {
          toast("Erinnerungen aktiv", "Ich erinnere dich zur eingestellten Uhrzeit.");
        }

        $("requestNotifyBtn").textContent = "Erinnerungen: aktiv";
        scheduleNextReminder();
      } else {
        remindersEnabled = false;
        if (reminderTimeout) clearTimeout(reminderTimeout);
        reminderTimeout = null;
        $("requestNotifyBtn").textContent = "Erinnerungen aktivieren";
        toast("Erinnerungen aus");
      }
    }

    // ---------- Add Task ----------
    function addTask() {
      const title = ($("taskTitle").value || "").trim();
      const project = $("taskProject").value;
      const prio = parseInt($("taskPrio").value, 10) || 3;
      const date = $("taskDeadline").value || "";
      const time = $("taskTime").value || "";
      const notes = ($("taskNotes").value || "").trim();

      if (!title) {
        toast("Titel fehlt", "Bitte oben einen Titel eingeben.");
        $("taskTitle").focus();
        return;
      }

      tasks.push({
        id: String(Date.now()),
        title,
        project,
        prio,
        date,
        time,
        notes,
        done: false,
        createdAt: Date.now()
      });

      $("taskTitle").value = "";
      $("taskDeadline").value = "";
      $("taskTime").value = "";
      $("taskNotes").value = "";

      save(tasks);
      renderAll();
      scheduleNextReminder();
      toast("Aufgabe hinzugef√ºgt");
    }

    // ---------- Bind UI ----------
    window.addEventListener("load", () => {
      // Default filter style
      document.querySelectorAll(".filterBtn").forEach(btn => {
        btn.className = "filterBtn flex-1 rounded-2xl py-2 text-xs font-extrabold uppercase bg-slate-100 text-slate-600";
      });
      const first = document.querySelector('.filterBtn[data-filter="active"]');
      if (first) first.className = "filterBtn flex-1 rounded-2xl py-2 text-xs font-extrabold uppercase bg-slate-900 text-white";

      document.querySelectorAll(".filterBtn").forEach(btn => {
        btn.addEventListener("click", () => {
          document.querySelectorAll(".filterBtn").forEach(b => b.className =
            "filterBtn flex-1 rounded-2xl py-2 text-xs font-extrabold uppercase bg-slate-100 text-slate-600"
          );
          btn.className = "filterBtn flex-1 rounded-2xl py-2 text-xs font-extrabold uppercase bg-slate-900 text-white";
          renderAll();
        });
      });

      $("projectFilter").addEventListener("change", renderAll);
      $("searchInput").addEventListener("input", renderAll);
      $("sortMode").addEventListener("change", renderAll);

      $("addTaskBtn").addEventListener("click", addTask);
      $("taskTitle").addEventListener("keydown", (e) => { if (e.key === "Enter") addTask(); });

      $("requestNotifyBtn").addEventListener("click", toggleReminders);

      renderAll();
      toast("Bereit", "Datum + Uhrzeit = Reminder m√∂glich");
    });
  </script>
</body>
</html>
